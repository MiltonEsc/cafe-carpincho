<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caf√© Carpincho - Vertical</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Librer√≠a Tone.js para los efectos de sonido -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0e8d9;
            user-select: none;
            overflow: hidden;
        }
        .game-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
        }
        .game-container {
            width: 100%;
            max-width: 450px; /* Ancho t√≠pico de m√≥vil */
            aspect-ratio: 9 / 16; /* Proporci√≥n de pantalla vertical */
            max-height: 95vh;
            background-color: #a98d71;
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            border: 10px solid #5d4037;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .top-bar {
            background-color: #a1887f;
            color: white;
            padding: 0.25rem 0.5rem;
            font-family: 'Fredoka One', cursive;
            font-size: clamp(0.7rem, 3vw, 1rem); /* Tama√±o de fuente ajustado */
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            gap: 0.25rem;
        }
        .counter-top {
            background-color: #d7ccc8;
            border-bottom: 8px solid #a1887f;
            position: relative;
            flex: 3; /* M√°s espacio para los clientes */
        }
        .ingredient-station {
            background-color: #eceff1;
            border-top: 8px solid #a1887f;
            position: relative;
            padding: 0.5rem;
            flex: 2; /* Menos espacio, m√°s compacto */
            display: flex;
            flex-direction: column;
        }
        .customer-area {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
        .customer {
            position: absolute;
            bottom: 1%;
            width: 25%; /* Ligeramente m√°s grandes en proporci√≥n */
            max-width: 90px;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
            transform: translateX(-50%) translateY(150px);
            opacity: 0;
        }
        .customer.active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .customer-display {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .customer-emoji {
            font-size: clamp(40px, 15vw, 70px);
            text-align: center;
            line-height: 1;
        }
        .customer.vip .customer-emoji {
            font-size: clamp(50px, 16vw, 80px) !important;
        }
        .customer-head {
            position: absolute;
            bottom: 95%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .order-bubble {
            background-color: white;
            border-radius: 20px;
            padding: 4px 8px;
            min-width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #5d4037;
            gap: 2px;
        }
         .order-bubble .emoji {
            font-size: clamp(1rem, 5vw, 1.5rem);
         }
        .patience-bar-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
            width: 80%;
        }
        .patience-bar-container {
            width: 100%;
            height: clamp(8px, 2vh, 12px);
            background-color: #4a4a4a;
            border-radius: 5px;
            border: 2px solid #fff;
            overflow: hidden;
        }
        .patience-bar {
            width: 100%;
            height: 100%;
            background-color: #4ade80;
            border-radius: 3px;
            transition: width 0.5s linear, background-color 0.5s ease;
        }
        .ingredient, .action-station {
            cursor: pointer;
            transition: transform 0.1s ease, opacity 0.2s ease;
            text-align: center;
            position: relative;
        }
        .ingredient.available, .action-station.available {
            opacity: 1;
        }
        .ingredient:not(.available), .action-station:not(.available) {
             opacity: 0.3;
             cursor: not-allowed;
        }
        .ingredient:active {
            transform: scale(0.9);
        }
        .action-station.usable {
            opacity: 1 !important;
            transform: scale(1.1);
            box-shadow: 0 0 15px #fdd835;
        }
        .action-station:active {
             transform: scale(0.95);
        }
        .ingredient-icon, .action-icon {
            font-size: clamp(1.8rem, 8vw, 2.5rem);
            line-height: 1;
        }
        /* MODIFICADO: Platos en fila horizontal */
        .plate-area {
            display: flex;
            flex-direction: row; /* Horizontal */
            justify-content: space-around;
            align-items: center;
            gap: 0.5rem;
            flex-grow: 1;
        }
        .plate {
            width: 30%; /* Ancho ajustado para fila */
            height: 65%; /* Alto ajustado para mantener forma circular */
            background-color: #fafafa;
            border: 4px solid #9e9e9e;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
        }
        .plate.active {
            border-color: #fdd835;
            box-shadow: 0 0 15px #fdd835;
        }
        .plate.processing {
            background-color: #b3e5fc;
            cursor: not-allowed;
        }
        .plate-item {
            font-size: clamp(0.8rem, 4vw, 1.2rem);
            line-height: 1;
            position: absolute;
        }
        .game-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 100;
            text-align: center;
            padding: 2rem;
        }
        .event-overlay {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Fredoka One', cursive;
            font-size: clamp(2rem, 10vw, 3rem);
            color: #f59e0b;
            text-shadow: 3px 3px #000;
            animation: pulse-and-fade 2s ease-out forwards;
            pointer-events: none;
            z-index: 101;
        }
        @keyframes pulse-and-fade {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        }
        .animate-shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }
        .floating-score { position: absolute; font-family: 'Fredoka One', cursive; color: #fdd835; font-size: 1.5rem; animation: float-up 1s ease-out forwards; pointer-events: none; z-index: 51; text-shadow: 2px 2px #000; }
        @keyframes float-up { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-50px); opacity: 0; } }
        .hidden { display: none; }
        .upgrade-card { background-color: #4b5563; border: 2px solid #9ca3af; border-radius: 1rem; padding: 1rem; width: 180px; display: flex; flex-direction: column; align-items: center; }
        .upgrade-card:disabled { opacity: 0.5; cursor: not-allowed; }
        .upgrade-icon { font-size: 1.25rem; margin-left: 0.5rem; }
        .upgrade-icon-patience { font-size: 1.25rem; }
        .coin-icon { display: inline-block; width: 1.25em; height: 1.25em; margin-left: 0.25em; vertical-align: -0.25em; }
        .time-penalty { animation: flash-red 0.5s; }
        @keyframes flash-red { from { color: #ef4444; transform: scale(1.2); } to { color: white; transform: scale(1.0); } }
        .progress-bar-container {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 10px;
            background-color: rgba(0,0,0,0.2);
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.1s linear;
        }
        .streak-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #f97316; /* orange-500 */
        }
        .streak-timer-container {
            width: 50px;
            height: 8px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        .streak-timer-bar {
            width: 100%;
            height: 100%;
            background-color: #fbbf24; /* amber-400 */
            border-radius: 4px;
            transition: width 0.1s linear;
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen">

    <div class="game-wrapper">
        <h1 class="text-2xl md:text-3xl font-bold text-[#5d4037] mb-2" style="font-family: 'Fredoka One', cursive;">Caf√© Carpincho</h1>

        <div id="game-container" class="game-container">
            <!-- PANTALLA DE INICIO -->
            <div id="start-screen" class="game-overlay">
                <h2 class="text-3xl md:text-4xl mb-4" style="font-family: 'Fredoka One', cursive;">Caf√© Carpincho</h2>
                <p class="text-md md:text-lg mb-8">¬°Atiende a tus amigos animales lo m√°s r√°pido que puedas!</p>
                <button id="start-game-btn" class="bg-yellow-500 text-gray-800 font-bold py-3 px-8 rounded-lg text-lg">Empezar a Jugar</button>
            </div>

            <!-- PANTALLA DE SUPERAR NIVEL / FIN DE JUEGO -->
            <div id="level-transition-screen" class="game-overlay hidden">
                <h2 id="transition-title" class="text-3xl mb-4" style="font-family: 'Fredoka One', cursive;"></h2>
                <p id="transition-text" class="text-lg mb-2"></p>
                <p id="coins-earned-text" class="text-md text-yellow-400 mb-6 flex items-center justify-center"></p>
                <div class="flex flex-col space-y-4">
                    <button id="shop-btn" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-lg text-lg">Tienda</button>
                    <button id="next-level-btn" class="bg-yellow-500 text-gray-800 font-bold py-3 px-8 rounded-lg text-lg"></button>
                </div>
            </div>
            
            <!-- TIENDA DE MEJORAS -->
            <div id="shop-screen" class="game-overlay hidden">
                 <h2 class="text-3xl mb-4" style="font-family: 'Fredoka One', cursive;">Tienda</h2>
                <div class="mb-6 flex items-center">Monedas: <span id="shop-coins-display" class="font-bold text-yellow-400 ml-2">0</span> <svg class="coin-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#facc15"/><text x="12" y="16" text-anchor="middle" font-size="12" font-weight="bold" fill="#a16207">C</text></svg></div>
                <!-- MODIFICADO: Tienda siempre en columna -->
                <div class="flex flex-col space-y-4 mb-8">
                    <button id="upgrade-time-btn" class="upgrade-card">
                        <div class="text-4xl mb-2">‚è±Ô∏è</div>
                        <p class="font-bold">Zapatillas R√°pidas</p>
                        <p class="text-sm mb-2 text-gray-300">A√±ade 5s al pr√≥ximo nivel</p>
                        <p class="text-lg flex items-center">Coste: <span id="upgrade-time-cost">20</span><svg class="coin-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#facc15"/><text x="12" y="16" text-anchor="middle" font-size="12" font-weight="bold" fill="#a16207">C</text></svg></p>
                    </button>
                    <button id="upgrade-patience-btn" class="upgrade-card">
                        <div class="text-4xl mb-2">‚òï</div>
                        <p class="font-bold">Caf√© de Calidad</p>
                        <p class="text-sm mb-2 text-gray-300">M√°s paciencia para el pr√≥ximo nivel</p>
                        <p class="text-lg flex items-center">Coste: <span id="upgrade-patience-cost">20</span><svg class="coin-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#facc15"/><text x="12" y="16" text-anchor="middle" font-size="12" font-weight="bold" fill="#a16207">C</text></svg></p>
                    </button>
                </div>
                <button id="close-shop-btn" class="bg-gray-500 text-white font-bold py-3 px-8 rounded-lg text-lg">Volver</button>
            </div>

            <!-- CONTENIDO DEL JUEGO (inicialmente oculto) -->
            <div id="game-content" class="flex flex-col h-full hidden">
                <div class="top-bar">
                    <div>Nvl: <span id="level-display">1</span></div>
                    <div><span id="level-score">0</span>/<span id="goal-display">0</span></div>
                    <div id="streak-display" class="streak-display hidden">
                        <span>üî•x<span id="streak-counter">0</span></span>
                        <div class="streak-timer-container">
                           <div id="streak-timer-bar" class="streak-timer-bar"></div>
                        </div>
                    </div>
                    <div class="flex items-center"><span id="total-coins-display">0</span><svg class="coin-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#facc15"/><text x="12" y="16" text-anchor="middle" font-size="12" font-weight="bold" fill="#a16207">C</text></svg></div>
                    <div class="flex items-center">T: <span id="timer">90</span><span id="time-upgrade-icon" class="upgrade-icon hidden">‚è±Ô∏è</span></div>
                </div>

                <div class="counter-top p-4">
                    <div id="customer-area" class="customer-area"></div>
                </div>

                <div class="ingredient-station">
                    <div id="plate-area" class="plate-area mb-2"></div>
                    <div id="bottom-stations" class="grid grid-cols-5 gap-1 mb-2">
                        <div class="ingredient" data-ingredient="üçì"><div class="ingredient-icon">üçì</div></div>
                        <div class="ingredient" data-ingredient="ÔøΩ"><div class="ingredient-icon">ü•¨</div></div>
                        <div class="ingredient" data-ingredient="ü•ï"><div class="ingredient-icon">ü•ï</div></div>
                        <div class="ingredient" data-ingredient="üåΩ"><div class="ingredient-icon">üåΩ</div></div>
                        <div id="chop-station" class="action-station" data-action="chop">
                            <div class="action-icon">üî™</div>
                            <div class="progress-bar-container"><div id="chop-progress" class="progress-bar"></div></div>
                        </div>
                        <div class="ingredient" data-ingredient="üçâ"><div class="ingredient-icon">üçâ</div></div>
                        <div class="ingredient special-ingredient" data-ingredient="üå∂Ô∏è"><div class="ingredient-icon">üå∂Ô∏è</div></div>
                        <div class="ingredient" data-ingredient="üçä"><div class="ingredient-icon">üçä</div></div>
                        <div></div> <!-- Espacio vac√≠o -->
                        <div id="juice-station" class="action-station" data-action="juice">
                            <div class="action-icon">üßÉ</div>
                            <div class="progress-bar-container"><div id="juice-progress" class="progress-bar"></div></div>
                        </div>
                    </div>
                    <div class="flex justify-center mt-auto space-x-4">
                        <button id="serve-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md">Servir</button>
                        <button id="trash-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg shadow-md">Tirar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const LEVELS = [
            { level: 1, goal: 5, time: 100, patience: 100, maxOrderSize: 1, availableIngredients: ['üçì', 'ü•¨', 'ü•ï'] },
            { level: 2, goal: 7, time: 90, patience: 95, maxOrderSize: 2, availableIngredients: ['üçì', 'ü•¨', 'ü•ï', 'üåΩ'], rushHourChance: 0.1, vipChance: 0.05 },
            { level: 3, goal: 10, time: 80, patience: 90, maxOrderSize: 2, availableIngredients: ['üçì', 'ü•¨', 'ü•ï', 'üåΩ', 'üçâ', 'chop'], rushHourChance: 0.15, vipChance: 0.07 },
            { level: 4, goal: 12, time: 75, patience: 85, maxOrderSize: 3, availableIngredients: ['üçì', 'ü•¨', 'ü•ï', 'üåΩ', 'üçâ', 'üå∂Ô∏è', 'chop'], rushHourChance: 0.2, vipChance: 0.08 },
            { level: 5, goal: 15, time: 70, patience: 80, maxOrderSize: 3, availableIngredients: ['üçì', 'ü•¨', 'ü•ï', 'üåΩ', 'üçâ', 'üå∂Ô∏è', 'chop'], rushHourChance: 0.25, vipChance: 0.1 },
            { level: 6, goal: 20, time: 65, patience: 75, maxOrderSize: 4, availableIngredients: ['üçì', 'ü•¨', 'ü•ï', 'üåΩ', 'üçâ', 'üå∂Ô∏è', 'chop'], rushHourChance: 0.3, vipChance: 0.12 },
            { level: 7, goal: 22, time: 60, patience: 70, maxOrderSize: 4, availableIngredients: ['üçì', 'ü•¨', 'ü•ï', 'üåΩ', 'üçâ', 'üå∂Ô∏è', 'üçä', 'chop', 'juice'], rushHourChance: 0.35, vipChance: 0.15 },
            { level: 8, goal: 25, time: 55, patience: 65, maxOrderSize: 5, availableIngredients: ['üçì', 'ü•¨', 'ü•ï', 'üåΩ', 'üçâ', 'üå∂Ô∏è', 'üçä', 'chop', 'juice'], rushHourChance: 0.4, vipChance: 0.2 }
        ];

        // --- CONSTANTES ---
        const CUSTOMERS = ['üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®'];
        const VIP_CUSTOMER = 'üëë';
        const SPECIAL_INGREDIENT = 'üå∂Ô∏è';
        const MAX_CUSTOMERS = 3;
        const SLOT_POSITIONS = [20, 50, 80];
        const NUM_PLATES = 3;
        const MAX_INGREDIENTS_PER_PLATE = 5;
        const VIP_REWARD = 50;
        const PROCESS_TIME = 2000;
        const PROCESSED_INGREDIENTS = { 'ü•¨': 'ü•ó', 'üçä': 'üßÉ' };
        const STREAK_BONUS_THRESHOLD = 3;
        const STREAK_DURATION = 5000;

        // --- DOM ELEMENTS ---
        const gameContainer = document.getElementById('game-container');
        const gameContent = document.getElementById('game-content');
        const startScreen = document.getElementById('start-screen');
        const startGameBtn = document.getElementById('start-game-btn');
        const plateArea = document.getElementById('plate-area');
        const trashBtn = document.getElementById('trash-btn');
        const serveBtn = document.getElementById('serve-btn');
        const customerArea = document.getElementById('customer-area');
        const levelScoreEl = document.getElementById('level-score');
        const totalCoinsEl = document.getElementById('total-coins-display');
        const timerEl = document.getElementById('timer');
        const timeUpgradeIcon = document.getElementById('time-upgrade-icon');
        const levelDisplayEl = document.getElementById('level-display');
        const goalDisplayEl = document.getElementById('goal-display');
        const levelTransitionScreen = document.getElementById('level-transition-screen');
        const transitionTitle = document.getElementById('transition-title');
        const transitionText = document.getElementById('transition-text');
        const coinsEarnedText = document.getElementById('coins-earned-text');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const shopBtn = document.getElementById('shop-btn');
        const shopScreen = document.getElementById('shop-screen');
        const closeShopBtn = document.getElementById('close-shop-btn');
        const shopCoinsDisplay = document.getElementById('shop-coins-display');
        const upgradeTimeBtn = document.getElementById('upgrade-time-btn');
        const upgradePatienceBtn = document.getElementById('upgrade-patience-btn');
        const upgradeTimeCostEl = document.getElementById('upgrade-time-cost');
        const upgradePatienceCostEl = document.getElementById('upgrade-patience-cost');
        const chopStation = document.getElementById('chop-station');
        const chopProgress = document.getElementById('chop-progress');
        const juiceStation = document.getElementById('juice-station');
        const juiceProgress = document.getElementById('juice-progress');
        const streakDisplay = document.getElementById('streak-display');
        const streakCounterEl = document.getElementById('streak-counter');
        const streakTimerBar = document.getElementById('streak-timer-bar');

        // --- GAME STATE ---
        let plates = [];
        let activePlateIndex = 0;
        let activeCustomers = [];
        let levelScore = 0;
        let totalCoins = 0;
        let timeLeft = 0;
        let gameInterval = null;
        let audioStarted = false;
        let isRushHourActive = false;
        let vipHasSpawnedThisLevel = false;
        let rushHourTimer = 0;
        let isProcessing = false;
        let streakCounter = 0;
        let streakTimer = STREAK_DURATION;
        let streakInterval = null;
        let currentLevelIndex = 0;
        
        let oneTimeBonuses = {
            time: 0,
            patience: 0
        };

        // --- SOUND MANAGER ---
        const soundManager = {
            polySynth: new Tone.PolySynth(Tone.Synth).toDestination(),
            playClick: () => { if (!audioStarted) return; new Tone.Synth().toDestination().triggerAttackRelease("C5", "16n"); },
            playSuccess: () => { if (!audioStarted) return; new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.1, release: 0.4 } }).toDestination().triggerAttackRelease("A5", "8n"); },
            playError: () => { if (!audioStarted) return; new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination().triggerAttackRelease("F#2", "8n"); },
            playTrash: () => { if (!audioStarted) return; new Tone.NoiseSynth({noise: {type: 'white'}, envelope: {attack: 0.005, decay: 0.1, sustain: 0}}).toDestination().triggerAttackRelease("8n"); },
            playLevelUp: () => { if (!audioStarted) return; new Tone.PolySynth(Tone.Synth).toDestination().triggerAttackRelease(["C4", "E4", "G4", "C5"], "4n", Tone.now()); },
            playGameOver: () => { if (!audioStarted) return; new Tone.PolySynth(Tone.Synth).toDestination().triggerAttackRelease(["C3", "A#2", "G#2", "F2"], "4n"); },
            playRushHour: () => { if (!audioStarted) return; new Tone.PolySynth(Tone.Synth).toDestination().triggerAttackRelease(["C4", "D#4", "G4", "A#4"], "4n", Tone.now()); },
            playVip: () => { if (!audioStarted) return; new Tone.PolySynth(Tone.Synth).toDestination().triggerAttackRelease(["G4", "B4", "D5"], "4n", Tone.now()); },
            playCoin: () => { if (!audioStarted) return; new Tone.Synth({envelope: {attack: 0.001, decay: 0.1, sustain: 0.1, release: 0.2}}).toDestination().triggerAttackRelease("B5", "16n"); },
            playChop: () => { if (!audioStarted) return; new Tone.Player({ url: "https://cdn.freesound.org/previews/244/244648_4284969-lq.mp3", autostart: true }).toDestination(); },
            playJuice: () => { if (!audioStarted) return; new Tone.Player({ url: "https://cdn.freesound.org/previews/204/204783_3525287-lq.mp3", autostart: true }).toDestination(); },
            playStreak: () => { if (!audioStarted) return; new Tone.Synth({oscillator: {type:'triangle'}, envelope:{attack:0.01, decay:0.1, sustain:0.1, release:0.2}}).toDestination().triggerAttackRelease("C6", "16n"); }
        };
        
        // --- GAME LOGIC ---
        function initializeGame() { totalCoins = 0; oneTimeBonuses = { time: 0, patience: 0 }; startLevel(0); }
        function startLevel(levelIndex) { if (levelIndex >= LEVELS.length) { showEndGame(true); return; } if (oneTimeBonuses.time > 0) { timeUpgradeIcon.classList.remove('hidden'); } else { timeUpgradeIcon.classList.add('hidden'); } const levelData = LEVELS[levelIndex]; currentLevelIndex = levelIndex; levelTransitionScreen.classList.add('hidden'); shopScreen.classList.add('hidden'); levelScore = 0; timeLeft = levelData.time + oneTimeBonuses.time; isRushHourActive = false; vipHasSpawnedThisLevel = false; resetStreak(); activeCustomers = new Array(MAX_CUSTOMERS).fill(null); plates = Array.from({ length: NUM_PLATES }, () => ({ ingredients: [], isProcessing: false })); activePlateIndex = 0; updateUI(); renderAllPlates(); updateAvailableIngredients(); customerArea.innerHTML = ''; spawnInitialCustomers(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(gameLoop, 1000); }
        function gameLoop() { timeLeft--; updateUI(); updatePatience(); if (isRushHourActive) { rushHourTimer--; if (rushHourTimer <= 0) endRushHour(); } else if (!vipHasSpawnedThisLevel) { const levelData = LEVELS[currentLevelIndex]; if (levelData.rushHourChance && timeLeft > 15 && timeLeft < levelData.time - 20) { if (Math.random() < levelData.rushHourChance) startRushHour(); } if (levelData.vipChance && timeLeft > 20 && timeLeft < levelData.time - 15) { startVipEvent(); } } if (timeLeft <= 0) showEndGame(false); }
        function showEndGame(didWinGame) { clearInterval(gameInterval); resetStreak(); if (didWinGame) { transitionTitle.textContent = "¬°Felicidades!"; transitionText.textContent = `¬°Has completado todos los niveles! Puntuaci√≥n Final: ${totalCoins}`; coinsEarnedText.innerHTML = ""; nextLevelBtn.textContent = "Jugar de Nuevo"; soundManager.playLevelUp(); currentLevelIndex = -1; } else { transitionTitle.textContent = "¬°Se acab√≥ el tiempo!"; transitionText.textContent = `Nivel ${currentLevelIndex + 1} no superado.`; coinsEarnedText.innerHTML = ""; nextLevelBtn.textContent = "Reintentar Nivel"; soundManager.playGameOver(); } shopBtn.classList.add('hidden'); levelTransitionScreen.classList.remove('hidden'); }
        function completeLevel() { clearInterval(gameInterval); const coinsEarned = levelScore; totalCoins += coinsEarned; soundManager.playLevelUp(); oneTimeBonuses = { time: 0, patience: 0 }; resetStreak(); transitionTitle.textContent = `¬°Nivel ${currentLevelIndex + 1} Superado!`; transitionText.textContent = "¬°Buen trabajo!"; coinsEarnedText.innerHTML = `Has ganado ${coinsEarned} <svg class="coin-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#facc15"/><text x="12" y="16" text-anchor="middle" font-size="12" font-weight="bold" fill="#a16207">C</text></svg>`; nextLevelBtn.textContent = "Siguiente Nivel"; shopBtn.classList.remove('hidden'); levelTransitionScreen.classList.remove('hidden'); }
        function serveActivePlate() { soundManager.playClick(); const plateToServe = plates[activePlateIndex].ingredients; if (plateToServe.length === 0) { handleIncorrectOrder(); return; } const customer = activeCustomers[activePlateIndex]; if (customer && arraysMatch(plateToServe, customer.order)) { let pointsGained = customer.isVip ? 0 : 1; if (!customer.isVip && customer.order.includes(SPECIAL_INGREDIENT)) pointsGained = 2; streakCounter++; let bonusCoins = 0; if (streakCounter > 0 && streakCounter % STREAK_BONUS_THRESHOLD === 0) { bonusCoins = 5; totalCoins += bonusCoins; soundManager.playStreak(); } levelScore += pointsGained; let coinsGained = customer.isVip ? VIP_REWARD : 0; totalCoins += coinsGained; soundManager.playSuccess(); if(customer.isVip) soundManager.playCoin(); animatePlateDelivery(activePlateIndex, plateToServe, pointsGained + bonusCoins, customer.isVip, bonusCoins > 0); clearActivePlate(); startStreakTimer(); } else { handleIncorrectOrder(); } }
        function handleIncorrectOrder() { soundManager.playError(); resetStreak(); timeLeft -= 5; timerEl.parentElement.classList.add('time-penalty'); setTimeout(() => { timerEl.parentElement.classList.remove('time-penalty'); }, 500); const customer = activeCustomers[activePlateIndex]; if (customer) { customer.patience -= 15; const patienceBarWrapper = document.querySelector(`#customer-${activePlateIndex} .patience-bar-wrapper`); if (patienceBarWrapper) { patienceBarWrapper.classList.add('animate-shake'); setTimeout(() => { patienceBarWrapper.classList.remove('animate-shake'); }, 500); } } const plateEl = document.getElementById(`plate-${activePlateIndex}`); if (plateEl) { plateEl.classList.add('animate-shake'); setTimeout(() => { clearActivePlate(); }, 500); } else { clearActivePlate(); } }
        function removeCustomer(index, wasServed, pointsOrCoins = 0, isVip = false, bonusCoins = 0) { const customerEl = document.getElementById(`customer-${index}`); if (wasServed && customerEl) { showFloatingScore(customerEl, pointsOrCoins, isVip, bonusCoins); } if(customerEl) customerEl.remove(); if (activeCustomers[index]?.isVip) vipHasSpawnedThisLevel = true; activeCustomers[index] = null; if(wasServed) updateUI(); else { resetStreak(); } if (levelScore >= LEVELS[currentLevelIndex].goal) { completeLevel(); return; } const spawnDelay = isRushHourActive ? 500 : 1500; setTimeout(tryToSpawnCustomer, spawnDelay); }
        function updateUI() { levelScoreEl.textContent = levelScore; totalCoinsEl.textContent = totalCoins; timerEl.textContent = Math.ceil(timeLeft); levelDisplayEl.textContent = LEVELS[currentLevelIndex].level; goalDisplayEl.textContent = LEVELS[currentLevelIndex].goal; if (streakCounter >= 2) { streakDisplay.classList.remove('hidden'); streakCounterEl.textContent = streakCounter; } else { streakDisplay.classList.add('hidden'); } }
        function showShop() { levelTransitionScreen.classList.add('hidden'); shopScreen.classList.remove('hidden'); updateShopUI(); }
        function closeShop() { shopScreen.classList.add('hidden'); levelTransitionScreen.classList.remove('hidden'); }
        function updateShopUI() { shopCoinsDisplay.textContent = totalCoins; const timeCost = 20; const patienceCost = 20; upgradeTimeCostEl.textContent = timeCost; upgradePatienceCostEl.textContent = patienceCost; upgradeTimeBtn.disabled = totalCoins < timeCost; upgradePatienceBtn.disabled = totalCoins < patienceCost; }
        function buyUpgrade(type) { soundManager.playClick(); const cost = 20; if (totalCoins >= cost) { totalCoins -= cost; if (type === 'time') oneTimeBonuses.time += 5; if (type === 'patience') oneTimeBonuses.patience += 10; soundManager.playCoin(); updateShopUI(); updateUI(); } }
        function spawnInitialCustomers() { for (let i = 0; i < MAX_CUSTOMERS; i++) { tryToSpawnCustomer(); } }
        function tryToSpawnCustomer() { const emptySlotIndex = activeCustomers.findIndex(c => c === null); if (emptySlotIndex !== -1) { spawnCustomer(emptySlotIndex); } }
        
        function spawnCustomer(slotIndex, isVip = false) {
            if (activeCustomers[slotIndex] !== null) return;
            const levelData = LEVELS[currentLevelIndex];
            let animal, order, patience;

            if (isVip) {
                animal = VIP_CUSTOMER;
                order = [];
                const orderSize = Math.min(levelData.maxOrderSize + 1, 4);
                const ingredientsForLevel = levelData.availableIngredients.filter(i => !['chop', 'juice'].includes(i));
                for (let i = 0; i < orderSize; i++) {
                    let ingredientToAdd = ingredientsForLevel[Math.floor(Math.random() * ingredientsForLevel.length)];
                    if (!order.includes(ingredientToAdd)) order.push(ingredientToAdd);
                    else i--;
                }
                patience = levelData.patience * 0.7;
            } else {
                animal = CUSTOMERS[Math.floor(Math.random() * CUSTOMERS.length)];
                order = [];
                const orderSize = Math.floor(Math.random() * levelData.maxOrderSize) + 1;
                
                const levelIngredients = levelData.availableIngredients;
                let ingredientsPool = levelIngredients.filter(i => !['chop', 'juice'].includes(i));
                if (levelIngredients.includes('chop')) {
                    ingredientsPool.push('ü•ó');
                }
                if (levelIngredients.includes('juice')) {
                    ingredientsPool.push('üßÉ');
                }

                for (let i = 0; i < orderSize; i++) {
                    let ingredientToAdd = ingredientsPool[Math.floor(Math.random() * ingredientsPool.length)];
                    if (!order.includes(ingredientToAdd)) {
                        order.push(ingredientToAdd);
                    } else { i--; }
                }
                patience = levelData.patience + oneTimeBonuses.patience;
            }

            activeCustomers[slotIndex] = { animal, order, patience, isVip };
            const customerDiv = document.createElement('div');
            customerDiv.className = isVip ? 'customer vip' : 'customer';
            customerDiv.id = `customer-${slotIndex}`;
            customerDiv.style.left = `${SLOT_POSITIONS[slotIndex]}%`;
            let orderHTML = order.map(item => `<div class="emoji">${item}</div>`).join('');
            customerDiv.innerHTML = `
                <div class="customer-display">
                    <div class="customer-head">
                        <div class="patience-bar-wrapper">
                            <span id="patience-upgrade-icon-${slotIndex}" class="upgrade-icon-patience hidden">‚òï</span>
                            <div class="patience-bar-container">
                                <div class="patience-bar" id="patience-${slotIndex}"></div>
                            </div>
                        </div>
                        <div class="order-bubble">${orderHTML}</div>
                    </div>
                    <div class="customer-emoji">${animal}</div>
                </div>`;
            customerArea.appendChild(customerDiv);
            if(oneTimeBonuses.patience > 0 && !isVip) {
                customerDiv.querySelector(`#patience-upgrade-icon-${slotIndex}`).classList.remove('hidden');
            }
            void customerDiv.offsetWidth;
            customerDiv.classList.add('active');
        }

        function updatePatience() { for (let i = 0; i < activeCustomers.length; i++) { const customer = activeCustomers[i]; if (customer) { let decrement = (100 / (LEVELS[currentLevelIndex].time + oneTimeBonuses.time)); if(isRushHourActive) decrement *= 1.3; if(customer.isVip) decrement *= 1.5; customer.patience -= decrement; const patienceBarEl = document.getElementById(`patience-${i}`); if (patienceBarEl) { patienceBarEl.style.width = `${customer.patience}%`; if (customer.patience < 50) patienceBarEl.style.backgroundColor = '#facc15'; if (customer.patience < 25) patienceBarEl.style.backgroundColor = '#f87171'; } if (customer.patience <= 0) { timeLeft -= 3; timerEl.parentElement.classList.add('time-penalty'); setTimeout(() => { timerEl.parentElement.classList.remove('time-penalty'); }, 500); soundManager.playError(); removeCustomer(i, false); } } } }
        function startRushHour() { isRushHourActive = true; rushHourTimer = 15; showEventMessage("¬°HORA PICO!"); soundManager.playRushHour(); }
        function endRushHour() { isRushHourActive = false; showEventMessage("Fin de la Hora Pico"); }
        function showEventMessage(message) { const eventDiv = document.createElement('div'); eventDiv.className = 'event-overlay'; eventDiv.textContent = message; gameContainer.appendChild(eventDiv); setTimeout(() => { if(gameContainer.contains(eventDiv)) { gameContainer.removeChild(eventDiv); } }, 2000); }
        function addIngredient(item) { if (isProcessing) return; const ingredientEl = document.querySelector(`.ingredient[data-ingredient="${item}"]`); if (!ingredientEl.classList.contains('available')) return; if (plates[activePlateIndex].ingredients.length >= MAX_INGREDIENTS_PER_PLATE) return; soundManager.playClick(); plates[activePlateIndex].ingredients.push(item); renderAllPlates(); }
        function clearActivePlate() { if (isProcessing) return; if (plates[activePlateIndex].ingredients.length > 0) { soundManager.playTrash(); } plates[activePlateIndex].ingredients = []; renderAllPlates(); }
        function selectPlate(index) { if (isProcessing) return; soundManager.playClick(); activePlateIndex = index; renderAllPlates(); }
        function renderAllPlates() { plateArea.innerHTML = ''; for (let i = 0; i < NUM_PLATES; i++) { const plateData = plates[i]; const plateEl = document.createElement('div'); plateEl.className = 'plate'; plateEl.id = `plate-${i}`; if (i === activePlateIndex) plateEl.classList.add('active'); if (plateData.isProcessing) plateEl.classList.add('processing'); plateData.ingredients.forEach((item) => { const itemSpan = document.createElement('span'); itemSpan.className = 'plate-item'; itemSpan.textContent = item; itemSpan.style.top = `${Math.random() * 40 + 10}%`; itemSpan.style.left = `${Math.random() * 60 + 15}%`; plateEl.appendChild(itemSpan); }); plateEl.addEventListener('click', () => selectPlate(i)); plateArea.appendChild(plateEl); } updateActionButtons(); }
        
        function updateAvailableIngredients() {
            const available = LEVELS[currentLevelIndex].availableIngredients;
            document.querySelectorAll('#bottom-stations > div[data-ingredient]').forEach(el => {
                el.classList.toggle('available', available.includes(el.dataset.ingredient));
            });
            document.querySelectorAll('#bottom-stations > div[data-action]').forEach(el => {
                el.classList.toggle('available', available.includes(el.dataset.action));
            });
        }

        function arraysMatch(arr1, arr2) { if (!arr1 || !arr2 || arr1.length !== arr2.length) return false; return [...arr1].sort().toString() === [...arr2].sort().toString(); }
        
        function updateActionButtons() {
            const currentPlate = plates[activePlateIndex];
            const canChop = currentPlate.ingredients.length === 1 && currentPlate.ingredients[0] === 'ü•¨';
            chopStation.classList.toggle('usable', canChop);
            const canJuice = currentPlate.ingredients.length === 1 && currentPlate.ingredients[0] === 'üçä';
            juiceStation.classList.toggle('usable', canJuice);
        }
        
        function setupEventListeners() {
            document.querySelectorAll('.ingredient').forEach(ing => {
                ing.addEventListener('click', () => addIngredient(ing.dataset.ingredient));
            });
            chopStation.addEventListener('click', () => processIngredient('chop'));
            juiceStation.addEventListener('click', () => processIngredient('juice'));
            trashBtn.addEventListener('click', clearActivePlate);
            serveBtn.addEventListener('click', serveActivePlate);
            shopBtn.addEventListener('click', showShop);
            closeShopBtn.addEventListener('click', closeShop);
            upgradeTimeBtn.addEventListener('click', () => buyUpgrade('time'));
            upgradePatienceBtn.addEventListener('click', () => buyUpgrade('patience'));
            nextLevelBtn.addEventListener('click', () => { soundManager.playClick(); if (nextLevelBtn.textContent.includes("Siguiente")) { startLevel(currentLevelIndex + 1); } else if (nextLevelBtn.textContent.includes("Reintentar")) { oneTimeBonuses = { time: 0, patience: 0 }; startLevel(currentLevelIndex); } else { initializeGame(); startScreen.classList.remove('hidden'); gameContent.classList.remove('hidden'); } });
            startGameBtn.addEventListener('click', () => {
                if (!audioStarted) {
                    Tone.start();
                    audioStarted = true;
                }
                initializeGame();
                startScreen.classList.add('hidden');
                gameContent.classList.remove('hidden');
            });
        }
        
        function processIngredient(stationType) {
            const currentPlate = plates[activePlateIndex];
            const stationEl = document.getElementById(stationType === 'chop' ? 'chop-station' : 'juice-station');
            const progressEl = document.getElementById(stationType === 'chop' ? 'chop-progress' : 'juice-progress');
            const ingredientToProcess = stationType === 'chop' ? 'ü•¨' : 'üçä';
            const soundToPlay = stationType === 'chop' ? soundManager.playChop : soundManager.playJuice;
            
            const canProcess = currentPlate.ingredients.length === 1 && currentPlate.ingredients[0] === ingredientToProcess;

            if (isProcessing || !stationEl.classList.contains('available') || !canProcess) return;
            
            isProcessing = true;
            currentPlate.isProcessing = true;
            renderAllPlates();
            soundToPlay();
            
            let progress = 0;
            progressEl.style.width = '0%';
            const interval = setInterval(() => {
                progress += 10;
                progressEl.style.width = `${progress}%`;
                if (progress >= 100) {
                    clearInterval(interval);
                    currentPlate.ingredients[0] = PROCESSED_INGREDIENTS[currentPlate.ingredients[0]];
                    progressEl.style.width = '0%';
                    currentPlate.isProcessing = false;
                    isProcessing = false;
                    renderAllPlates();
                }
            }, PROCESS_TIME / 10);
        }

        function animatePlateDelivery(customerIndex, plateContent, pointsGained, isVip) { const plateEl = document.getElementById(`plate-${customerIndex}`); const customerEl = document.getElementById(`customer-${customerIndex}`); const containerRect = gameContainer.getBoundingClientRect(); if (!plateEl || !customerEl) return; const startRect = plateEl.getBoundingClientRect(); const endRect = customerEl.getBoundingClientRect(); const flyingPlate = document.createElement('div'); flyingPlate.className = 'flying-plate'; flyingPlate.innerHTML = plateContent.map(item => `<span class="plate-item">${PROCESSED_INGREDIENTS[item] || item}</span>`).join(''); const startX = startRect.left - containerRect.left + (startRect.width / 2) - 40; const startY = startRect.top - containerRect.top + (startRect.height / 2) - 20; const endX = endRect.left - containerRect.left + (endRect.width / 2) - 40; const endY = endRect.top - containerRect.top; flyingPlate.style.left = `${startX}px`; flyingPlate.style.top = `${startY}px`; gameContainer.appendChild(flyingPlate); requestAnimationFrame(() => { flyingPlate.style.left = `${endX}px`; flyingPlate.style.top = `${endY}px`; flyingPlate.style.transform = 'scale(0.5)'; flyingPlate.style.opacity = '0'; }); setTimeout(() => { if(gameContainer.contains(flyingPlate)) { gameContainer.removeChild(flyingPlate); } removeCustomer(customerIndex, true, pointsGained, isVip); }, 500); }
        function showFloatingScore(customerEl, pointsOrCoins, isVip, bonusCoins) { if (!customerEl) return; const containerRect = gameContainer.getBoundingClientRect(); const customerRect = customerEl.getBoundingClientRect(); const scoreText = document.createElement('div'); scoreText.className = 'floating-score'; let content = ''; if(isVip) { content = `+${pointsOrCoins} <svg class="coin-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#facc15"/><text x="12" y="16" text-anchor="middle" font-size="12" font-weight="bold" fill="#a16207">C</text></svg>`; } else { content = `+${pointsOrCoins}`; } if (bonusCoins > 0) { content += ` +${bonusCoins} <svg class="coin-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#facc15"/><text x="12" y="16" text-anchor="middle" font-size="12" font-weight="bold" fill="#a16207">C</text></svg>`; } scoreText.innerHTML = content; const x = customerRect.left - containerRect.left + (customerRect.width / 2) - 15; const y = customerRect.top - containerRect.top; scoreText.style.left = `${x}px`; scoreText.style.top = `${y}px`; gameContainer.appendChild(scoreText); setTimeout(() => { if(gameContainer.contains(scoreText)) { gameContainer.removeChild(scoreText); } }, 1500); }
        function startVipEvent() { if (vipHasSpawnedThisLevel) return; const emptySlot = activeCustomers.findIndex(c => c === null); if (emptySlot === -1) return; vipHasSpawnedThisLevel = true; showEventMessage("¬°CLIENTE VIP!"); soundManager.playVip(); spawnCustomer(emptySlot, true); }
        function resetStreak() { clearInterval(streakInterval); streakInterval = null; streakCounter = 0; streakTimer = STREAK_DURATION; updateUI(); }
        function startStreakTimer() { streakTimer = STREAK_DURATION; if (!streakInterval) { streakInterval = setInterval(streakLoop, 100); } }
        function streakLoop() { streakTimer -= 100; const percentage = (streakTimer / STREAK_DURATION) * 100; if (streakTimerBar) { streakTimerBar.style.width = `${percentage}%`; } if (streakTimer <= 0) { resetStreak(); } }

        setupEventListeners();
    </script>
</body>
</html>
